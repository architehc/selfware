54:3. **Missing `running` decrement in `fail()`**: Only increments failed, doesn't decrement running
77:<arguments>{"new_str": "    /// Mark the current task as failed.\n    pub async fn fail(&self) {\n        let mut state = self.state.lock().await;\n        state.running -= 1;\n        state.failed += 1;\n    }", "old_str": "    /// Mark the current task as failed.\n    ///\n    /// BUG: Increments failed but forgets to decrement running.\n    pub async fn fail(&self) {\n        let mut state = self.state.lock().await;\n        // BUG: missing `state.running -= 1;`\n        state.failed += 1;\n    }", "path": "./src/lib.rs"}</arguments>
82:<arguments>{"new_str": "    /// Return a snapshot of (running, completed, failed).\n    pub async fn snapshot(&self) -> (u32, u32, u32) {\n        let state = self.state.lock().await;\n        (state.running, state.completed, state.failed)\n    }", "old_str": "    /// Return a snapshot of (running, completed, failed).\n    ///\n    /// BUG: Split lock - reads running under one lock acquisition,\n    /// then reads completed and failed under another. The state can\n    /// change between the two reads, giving an inconsistent view.\n    pub async fn snapshot(&self) -> (u32, u32, u32) {\n        let running = {\n            let state = self.state.lock().await;\n            state.running\n        };\n        // ^^^ Lock dropped. State can mutate here.\n        let (completed, failed) = {\n            let state = self.state.lock().await;\n            (state.completed, state.failed)\n        };\n        (running, completed, failed)\n    }", "path": "./src/lib.rs"}</arguments>
116:3. **`fail()` - Missing counter decrement**: Added `state.running -= 1` which was missing. Now properly decrements running AND increments failed.
118:4. **`snapshot()` - Split lock**: Combined all three counter reads into a single lock acquisition. Previously it read running under one lock, then completed/failed under another - allowing inconsistent views where values came from different points in time.
131:3. **`fail()` - Missing counter decrement**: Added `state.running -= 1` which was missing. Now properly decrements running AND increments failed.
133:4. **`snapshot()` - Split lock**: Combined all three counter reads into a single lock acquisition. Previously it read running under one lock, then completed/failed under another - allowing inconsistent views where values came from different points in time.
